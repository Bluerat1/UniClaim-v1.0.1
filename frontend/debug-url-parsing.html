<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Cloudinary URL Parsing</title>
    <style>
        body {
            font-family: Arial, sansospace;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }

        .url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }

        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .test-button:hover {
            background: #0056b3;
        }

        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .url-example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
            border-left: 4px solid #007bff;
        }
    </style>
</head>

<body>
    <h1>üîç Debug Cloudinary URL Parsing</h1>

    <div class="test-section">
        <h2>üß™ Test URL Parsing</h2>
        <p>Enter a Cloudinary URL to test the parsing logic:</p>
        <input type="text" id="urlInput" class="url-input"
            placeholder="https://res.cloudinary.com/your-cloud/image/upload/v1234567890/posts/image.jpg">
        <button onclick="testSingleUrl()" class="test-button">Test This URL</button>
        <button onclick="testAllExamples()" class="test-button">Test All Examples</button>
        <button onclick="clearLog()" class="test-button">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>üìù Test Results</h2>
        <div class="log" id="log"></div>
    </div>

    <div class="test-section">
        <h2>üí° Common Cloudinary URL Formats</h2>
        <div class="url-example">
            <strong>Basic format:</strong><br>
            https://res.cloudinary.com/cloud_name/image/upload/posts/image.jpg
        </div>
        <div class="url-example">
            <strong>With version:</strong><br>
            https://res.cloudinary.com/cloud_name/image/upload/v1234567890/posts/image.jpg
        </div>
        <div class="url-example">
            <strong>With folder structure:</strong><br>
            https://res.cloudinary.com/cloud_name/image/upload/posts/folder/subfolder/image.jpg
        </div>
        <div class="url-example">
            <strong>API format:</strong><br>
            https://api.cloudinary.com/v1_1/cloud_name/image/upload/posts/image.jpg
        </div>
    </div>

    <div class="test-section">
        <h2>üîß How the Parsing Works</h2>
        <ol>
            <li><strong>Find 'upload' keyword</strong> - Locates the position after 'upload' in the URL</li>
            <li><strong>Extract path parts</strong> - Gets everything after 'upload'</li>
            <li><strong>Remove version number</strong> - Strips 'v1234567890' if present</li>
            <li><strong>Remove file extension</strong> - Removes .jpg, .png, etc.</li>
            <li><strong>Join remaining parts</strong> - Creates the public ID for deletion</li>
        </ol>

        <h3>Example:</h3>
        <p><strong>Input URL:</strong> https://res.cloudinary.com/demo/image/upload/v1234567890/posts/folder/image.jpg
        </p>
        <p><strong>After 'upload':</strong> v1234567890/posts/folder/image.jpg</p>
        <p><strong>After removing version:</strong> posts/folder/image.jpg</p>
        <p><strong>After removing extension:</strong> posts/folder/image</p>
        <p><strong>Final Public ID:</strong> posts/folder/image</p>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';

            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function extractCloudinaryPublicId(url) {
            try {
                log(`üîç Extracting public ID from: ${url}`, 'info');

                // Handle different Cloudinary URL formats
                if (url.includes('res.cloudinary.com')) {
                    // Format: https://res.cloudinary.com/cloud_name/image/upload/v1234567890/folder/image_name.jpg
                    const urlParts = url.split('/');
                    const uploadIndex = urlParts.findIndex(part => part === 'upload');

                    if (uploadIndex !== -1) {
                        // Get everything after 'upload' but before any version number
                        let publicIdParts = urlParts.slice(uploadIndex + 1);

                        // Remove version number if present (starts with 'v' followed by numbers)
                        const versionIndex = publicIdParts.findIndex(part => /^v\d+$/.test(part));
                        if (versionIndex !== -1) {
                            log(`üìù Found version number: ${publicIdParts[versionIndex]}`, 'info');
                            publicIdParts = publicIdParts.slice(versionIndex + 1);
                        }

                        // Remove file extension from the last part
                        if (publicIdParts.length > 0) {
                            const lastPart = publicIdParts[publicIdParts.length - 1];
                            const extensionIndex = lastPart.lastIndexOf('.');
                            if (extensionIndex !== -1) {
                                const extension = lastPart.substring(extensionIndex);
                                log(`üìù Removing file extension: ${extension}`, 'info');
                                publicIdParts[publicIdParts.length - 1] = lastPart.substring(0, extensionIndex);
                            }
                        }

                        const publicId = publicIdParts.join('/');
                        log(`‚úÖ Successfully extracted public ID: ${publicId}`, 'success');
                        return publicId;
                    }
                } else if (url.includes('api.cloudinary.com')) {
                    // Format: https://api.cloudinary.com/v1_1/cloud_name/image/upload/...
                    const urlParts = url.split('/');
                    const uploadIndex = urlParts.findIndex(part => part === 'upload');

                    if (uploadIndex !== -1) {
                        const publicIdParts = urlParts.slice(uploadIndex + 1);
                        const publicId = publicIdParts.join('/');
                        log(`‚úÖ Successfully extracted public ID from API URL: ${publicId}`, 'success');
                        return publicId;
                    }
                }

                log(`‚ùå Could not parse Cloudinary URL format: ${url}`, 'error');
                return null;

            } catch (error) {
                log(`‚ùå Error extracting public ID from URL: ${url}`, 'error');
                log(`Error details: ${error.message}`, 'error');
                return null;
            }
        }

        function testSingleUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                log('‚ùå Please enter a URL to test', 'error');
                return;
            }

            log(`üß™ Testing single URL: ${url}`, 'info');
            const publicId = extractCloudinaryPublicId(url);

            if (publicId) {
                log(`üéØ Final result - Public ID: ${publicId}`, 'success');
            } else {
                log(`‚ùå Failed to extract public ID`, 'error');
            }
        }

        function testAllExamples() {
            const testUrls = [
                'https://res.cloudinary.com/demo/image/upload/v1234567890/posts/test_image.jpg',
                'https://res.cloudinary.com/demo/image/upload/posts/folder/test_image.png',
                'https://res.cloudinary.com/demo/image/upload/v987654321/posts/folder/subfolder/image.jpg',
                'https://api.cloudinary.com/v1_1/demo/image/upload/posts/test.jpg',
                'https://res.cloudinary.com/uniclaim/image/upload/posts/lost_item_photo.jpg',
                'https://res.cloudinary.com/uniclaim/image/upload/v1703123456/posts/found_items/phone.jpg'
            ];

            log('üß™ Testing all example URLs...', 'info');

            testUrls.forEach((url, index) => {
                log(`\n--- Test ${index + 1} ---`, 'info');
                const publicId = extractCloudinaryPublicId(url);

                if (publicId) {
                    log(`‚úÖ Test ${index + 1} PASSED - Public ID: ${publicId}`, 'success');
                } else {
                    log(`‚ùå Test ${index + 1} FAILED`, 'error');
                }
            });
        }

        // Load page
        window.addEventListener('load', () => {
            log('üöÄ URL parsing debug tool loaded. Enter a Cloudinary URL or test examples.', 'info');
        });
    </script>
</body>

</html>