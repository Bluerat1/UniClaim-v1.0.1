#!/usr/bin/env node

// Script to generate firebase-messaging-sw.js from environment variables
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables
import { config } from 'dotenv';
config({ path: path.join(__dirname, '..', '.env') });

// Firebase configuration from environment variables
const firebaseConfig = {
    apiKey: process.env.VITE_FIREBASE_API_KEY,
    authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,
    projectId: process.env.VITE_FIREBASE_PROJECT_ID,
    storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.VITE_FIREBASE_APP_ID,
    measurementId: process.env.VITE_FIREBASE_MEASUREMENT_ID
};

// Validate required environment variables
const requiredVars = [
    'VITE_FIREBASE_API_KEY',
    'VITE_FIREBASE_AUTH_DOMAIN',
    'VITE_FIREBASE_PROJECT_ID',
    'VITE_FIREBASE_STORAGE_BUCKET',
    'VITE_FIREBASE_MESSAGING_SENDER_ID',
    'VITE_FIREBASE_APP_ID'
];

const missingVars = requiredVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
    console.error('‚ùå Missing required environment variables:');
    missingVars.forEach(varName => {
        console.error(`   - ${varName}`);
    });
    console.error('\nPlease set these variables in your .env file and try again.');
    process.exit(1);
}

// Service worker template
const serviceWorkerTemplate = `// Firebase Cloud Messaging Service Worker
// This file is automatically generated from environment variables
// DO NOT EDIT MANUALLY - Run "npm run generate-service-worker" to regenerate

importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

// Initialize Firebase in the service worker
const firebaseConfig = {
    apiKey: "${firebaseConfig.apiKey}",
    authDomain: "${firebaseConfig.authDomain}",
    projectId: "${firebaseConfig.projectId}",
    storageBucket: "${firebaseConfig.storageBucket}",
    messagingSenderId: "${firebaseConfig.messagingSenderId}",
    appId: "${firebaseConfig.appId}"${firebaseConfig.measurementId ? `,
    measurementId: "${firebaseConfig.measurementId}"` : ''}
};

firebase.initializeApp(firebaseConfig);

// Initialize Firebase Cloud Messaging
const messaging = firebase.messaging();

// Handle background messages
messaging.onBackgroundMessage((payload) => {
    console.log('Received background message:', payload);

    const notificationTitle = payload.notification?.title || 'UniClaim';
    const notificationOptions = {
        body: payload.notification?.body || 'You have a new notification',
        icon: '/uniclaim_logo.png',
        badge: '/uniclaim_logo.png',
        data: payload.data,
        actions: [
            {
                action: 'view',
                title: 'View'
            },
            {
                action: 'dismiss',
                title: 'Dismiss'
            }
        ]
    };

    self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification click
self.addEventListener('notificationclick', (event) => {
    console.log('üîî Notification clicked:', event);
    console.log('üîî Notification data:', event.notification.data);

    event.notification.close();

    if (event.action === 'dismiss') {
        console.log('üö´ Notification dismissed');
        return;
    }

    // Handle the click action
    const data = event.notification.data;
    let url = '/';

    console.log('üîç Processing notification data:', data);

    if (data?.postId) {
        url = \`/post/\${data.postId}\`;
        console.log('üìç Post URL:', url);
    } else if (data?.conversationId) {
        url = \`/messages?conversation=\${data.conversationId}\`;
        console.log('üí¨ Conversation URL:', url);
    } else {
        console.log('‚ùå No postId or conversationId found in notification data');
    }

    console.log('üéØ Final URL to open:', url);

    // Open the app
    event.waitUntil(
        (async () => {
            try {
                console.log('üîç Attempting to open URL:', url);

                // Try to focus existing window first
                const clientsList = await clients.matchAll({
                    type: 'window',
                    includeUncontrolled: true
                });

                console.log('üîç Found', clientsList.length, 'clients');

                for (const client of clientsList) {
                    console.log('üîç Checking client:', client.url);

                    // If we're already on the messages page and have a conversation param, open new window
                    if (url.includes('conversation=') && (client.url.includes('/messages') || client.url.includes('/'))) {
                        console.log('‚úÖ Found suitable window, opening new one for conversation');
                        if (clients.openWindow) {
                            return clients.openWindow(url);
                        }
                    }
                }

                // Otherwise, open in new window
                console.log('ü™ü Opening new window');
                if (clients.openWindow) {
                    return clients.openWindow(url);
                } else {
                    console.error('‚ùå clients.openWindow not available, trying fallback');
                    // Fallback: try to navigate current context
                    if (typeof window !== 'undefined' && window.location) {
                        window.location.href = url;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error in notification navigation:', error);
                // Last resort fallback
                try {
                    if (clients.openWindow) {
                        clients.openWindow(url);
                    }
                } catch (fallbackError) {
                    console.error('‚ùå Fallback also failed:', fallbackError);
                }
            }
        })()
    );
});`;

// Write the generated service worker to the public directory
const publicDir = path.join(__dirname, '..', 'public');
const serviceWorkerPath = path.join(publicDir, 'firebase-messaging-sw.js');

// Ensure public directory exists
if (!fs.existsSync(publicDir)) {
    fs.mkdirSync(publicDir, { recursive: true });
}

// Write the service worker file
fs.writeFileSync(serviceWorkerPath, serviceWorkerTemplate);

console.log('‚úÖ firebase-messaging-sw.js generated successfully!');
console.log(`üìÅ Location: ${serviceWorkerPath}`);
console.log('üî• Firebase configuration loaded from environment variables');
